#!/usr/bin/env bash

#ddev-generated
## Command provided by https://github.com/colinstillwell/ddev-site-devkit
## Description: Run a script on the host or in a specified service.
## Usage: devkit-script-run [flags] -- [script-args]
## Example: ddev devkit-script-run --script="scripts/example.sh" --location="web" -- script-arg1 script-arg2
## Flags: [{"Name":"script","Usage":"Path to the script to run, relative to the project root","Type":"string"},{"Name":"location","Usage":"Where to run the script: 'host' or a service name such as 'web'","Type":"string"}]
## Aliases: devkit:script:run,devkit-run-script,devkit:run:script

# Exit on error; treat unset variables as errors; fail pipelines if any command fails
set -euo pipefail

# Defaults
SCRIPT=""
LOCATION=""

# Parse flags
for ARG in "$@"; do
  case "$ARG" in
    --script=*)   SCRIPT="${ARG#*=}"; shift; continue ;;
    --location=*) LOCATION="${ARG#*=}"; shift; continue ;;
    --) shift; break ;;
    *) ddev devkit-log --message="Unknown flag: $ARG" --type="error"; exit 2 ;;
  esac
done

# Validate flags
[[ -n "$SCRIPT" ]]   || { ddev devkit-log --message="--script is required." --type="error"; exit 2; }
[[ -n "$LOCATION" ]] || { ddev devkit-log --message="--location is required." --type="error"; exit 2; }

# Guards
if [[ "$LOCATION" == "host" ]]; then
  SCRIPT_PATH="$DDEV_APPROOT/$SCRIPT"

  if [[ -d "$SCRIPT_PATH" ]]; then
    ddev devkit-log --message="'$SCRIPT_PATH' is a directory. Refusing to run." --type="error"
    exit 1
  fi

  if [[ ! -f "$SCRIPT_PATH" ]]; then
    ddev devkit-log --message="'$SCRIPT_PATH' not found. Cannot run." --type="error"
    exit 1
  fi
else
  SCRIPT_PATH="$SCRIPT"

  if ! ddev exec -s "$LOCATION" bash -lc 'true' > /dev/null 2>&1; then
    ddev devkit-log --message="Service '$LOCATION' not found or not running." --type="error"
    exit 1
  fi

  if ddev exec -s "$LOCATION" bash -lc "test -d $SCRIPT_PATH" > /dev/null 2>&1; then
    ddev devkit-log --message="'$SCRIPT_PATH' is a directory. Refusing to run." --type="error"
    exit 1
  fi

  if ! ddev exec -s "$LOCATION" bash -lc "test -f $SCRIPT_PATH" > /dev/null 2>&1; then
    ddev devkit-log --message="'$SCRIPT_PATH' not found. Cannot run." --type="error"
    exit 1
  fi
fi

# Commands
ddev devkit-log --message="Running script '$SCRIPT' in '$LOCATION'." --type="starting"

if [[ "$LOCATION" == "host" ]]; then
  bash "$SCRIPT_PATH" "$@"
else
  ddev exec -s "$LOCATION" bash "$SCRIPT_PATH" "$@"
fi

ddev devkit-log --message="Running script '$SCRIPT' in '$LOCATION'." --type="finished"
