#!/usr/bin/env bash

#ddev-generated
## Command provided by https://github.com/colinstillwell/ddev-site-devkit
## Description: Compare config and report keys present in reference but missing in target.
## Usage: devkit-config-diff [flags]
## Example: ddev devkit-config-diff --format="env" --reference=".env.example" --target=".env"
## Flags: [{"Name":"format","Usage":"How to interpret the config","Type":"string"},{"Name":"reference","Usage":"Path to the reference config, relative to the project root","Type":"string"},{"Name":"target","Usage":"Path to the target config, relative to the project root","Type":"string"}]
## Aliases: devkit:config:diff,devkit-diff-config,devkit:diff:config

# Exit on error; treat unset variables as errors; fail pipelines if any command fails
set -euo pipefail

# Defaults
FORMAT=""
REFERENCE=""
TARGET=""

# Parse flags
for ARG in "$@"; do
  case "$ARG" in
    --format=*)    FORMAT="${ARG#*=}"; shift; continue ;;
    --reference=*) REFERENCE="${ARG#*=}"; shift; continue ;;
    --target=*)    TARGET="${ARG#*=}"; shift; continue ;;
    *) ddev devkit-log --message="Unknown flag: $ARG" --type="error"; exit 2 ;;
  esac
done

# Validate flags
[[ -n "$FORMAT" ]]    || { ddev devkit-log --message="--format is required." --type="error"; exit 2; }
[[ -n "$REFERENCE" ]] || { ddev devkit-log --message="--reference is required." --type="error"; exit 2; }
[[ -n "$TARGET" ]]    || { ddev devkit-log --message="--target is required." --type="error"; exit 2; }

# Guards
if [[ "$FORMAT" != "env" ]]; then
  ddev devkit-log --message="Unsupported --format '$FORMAT'. Only 'env' is supported for now." --type="error"
  exit 2
fi

REFERENCE_PATH="$DDEV_APPROOT/$REFERENCE"
TARGET_PATH="$DDEV_APPROOT/$TARGET"

if [[ -d "$REFERENCE_PATH" ]]; then
  ddev devkit-log --message="'$REFERENCE_PATH' is a directory. Cannot compare with '$TARGET_PATH'." --type="error"
  exit 1
fi

if [[ -d "$TARGET_PATH" ]]; then
  ddev devkit-log --message="'$TARGET_PATH' is a directory. Cannot compare with '$REFERENCE_PATH'." --type="error"
  exit 1
fi

if [[ ! -f "$REFERENCE_PATH" ]]; then
  ddev devkit-log --message="'$REFERENCE_PATH' not found. Cannot compare with '$TARGET_PATH'." --type="error"
  exit 1
fi

if [[ ! -f "$TARGET_PATH" ]]; then
  ddev devkit-log --message="'$TARGET_PATH' not found. Cannot compare with '$REFERENCE_PATH'." --type="error"
  exit 1
fi

# Commands
ddev devkit-log --message="Comparing '$REFERENCE' to '$TARGET'..."

extract_env_keys() {
  awk -F'=' '
    /^[[:space:]]*#/ { next }
    /^[[:space:]]*$/ { next }
    {
      line=$0
      sub(/\r$/,"", line)
      sub(/^[[:space:]]*export[[:space:]]+/, "", line)
      split(line, parts, "=")
      key=parts[1]
      sub(/^[[:space:]]+/, "", key)
      sub(/[[:space:]]+$/, "", key)
      if (key ~ /^[A-Za-z_][A-Za-z0-9_]*$/) print key
    }
  ' "$1" | sort -u
}

MISSING=$(
  comm -23 <(extract_env_keys "$REFERENCE_PATH") <(extract_env_keys "$TARGET_PATH") || true
)

if [[ -z "$MISSING" ]]; then
  ddev devkit-log --message="All keys in '$REFERENCE' are present in '$TARGET'." --type="success"
  exit 0
fi

ddev devkit-log --message="The following keys are in '$REFERENCE' but are missing from '$TARGET':" --type="error"
printf '%s\n' "$MISSING"
exit 1
