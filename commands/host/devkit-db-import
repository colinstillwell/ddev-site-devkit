#!/usr/bin/env bash

#ddev-generated
## Command provided by https://github.com/colinstillwell/ddev-site-devkit
## Description: Interactively import an SQL dump into the project database.
## Usage: devkit-db-import [flags]
## Example: ddev devkit-db-import (default directory: "database")\nddev devkit-db-import --directory="backups"
## Flags: [{"Name":"directory","Usage":"Path to the directory to look for dump files, relative to the project root","Type":"string"}]
## Aliases: devkit:db:import,devkit-import-db,devkit:import:db,devkit-database-import,devkit:database:import,devkit-import-database,devkit:import:database

# Exit on error; treat unset variables as errors; fail pipelines if any command fails
set -euo pipefail

# Defaults
DIRECTORY="database"

# Parse flags
for ARG in "$@"; do
  case "$ARG" in
    --directory=*) DIRECTORY="${ARG#*=}"; shift; continue ;;
    --dir=*)       DIRECTORY="${ARG#*=}"; shift; continue ;;
    *) ddev devkit-log --message="Unknown flag: $ARG" --type="error"; exit 2 ;;
  esac
done

# Guards
DIRECTORY_PATH="$DDEV_APPROOT/$DIRECTORY"

if [[ ! -d "$DIRECTORY_PATH" ]]; then
  ddev devkit-log --message="Directory not found. Cannot locate dump files in '$DIRECTORY_PATH'." --type="error"
  exit 1
fi

shopt -s nullglob
FILES=(
  "$DIRECTORY_PATH"/*.sql
  "$DIRECTORY_PATH"/*.sql.gz
  "$DIRECTORY_PATH"/*.sql.bz2
  "$DIRECTORY_PATH"/*.sql.xz
  "$DIRECTORY_PATH"/*.mysql
  "$DIRECTORY_PATH"/*.mysql.gz
  "$DIRECTORY_PATH"/*.zip
  "$DIRECTORY_PATH"/*.tgz
  "$DIRECTORY_PATH"/*.tar
  "$DIRECTORY_PATH"/*.tar.gz
  "$DIRECTORY_PATH"/*.tar.bz2
  "$DIRECTORY_PATH"/*.tar.xz
)
shopt -u nullglob

if (( ${#FILES[@]} == 0 )); then
  ddev devkit-log --message="Cannot locate dump files in '$DIRECTORY_PATH'." --type="error"
  exit 1
fi

# Newest first by modification time
IFS=$'\n' FILES=($(ls -1t "${FILES[@]}"))
unset IFS

# Prompts
ddev devkit-log --message="Choose a dump file to import from '$DIRECTORY_PATH':"
for i in "${!FILES[@]}"; do
  printf "%2d) %s\n" $((i+1)) "$(basename -- "${FILES[$i]}")" >&2
done

while true; do
  printf "Enter a number 1-%d (0 to skip): " "${#FILES[@]}" >&2
  read -r n

  if [[ "$n" =~ ^[0-9]+$ ]]; then
    if (( n==0 )); then
      ddev devkit-log --message="Database import skipped." --type="warning"
      exit 0
    elif (( n>=1 && n<=${#FILES[@]} )); then
      CHOICE="${FILES[$((n-1))]}"
      break
    fi
  fi

  ddev devkit-log --message="Invalid selection. Please try again." --type="error"
done

# Commands
ddev devkit-log --message="Importing database dump file '$(basename -- "$CHOICE")'..."
exec ddev import-db -f "$CHOICE"
